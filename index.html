<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Reach Grades Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 100vh; }
    #controls, #legend, .search-box {
      position: absolute;
      z-index: 1000;
      background: white;
      padding: 8px;
      border: 1px solid #ccc;
      font-family: sans-serif;
    }
    #controls {
      top: 60px;
      right: 10px;
    }
    #legend {
      bottom: 10px;
      left: 10px;
    }
    .legend-color {
      display: inline-block;
      width: 16px;
      height: 16px;
      margin-right: 6px;
      vertical-align: middle;
    }
    .search-box {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 6px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <div id="controls">
    <label for="parameterSelect"><strong>Select Parameter:</strong></label><br>
    <select id="parameterSelect"></select><br><br>
    <strong>Show Grades:</strong><br>
    <label><input type="checkbox" class="gradeFilter" value="A" checked> A</label>
    <label><input type="checkbox" class="gradeFilter" value="B" checked> B</label>
    <label><input type="checkbox" class="gradeFilter" value="C" checked> C</label>
    <label><input type="checkbox" class="gradeFilter" value="D" checked> D</label>
    <label><input type="checkbox" class="gradeFilter" value="F" checked> F</label>
    <label><input type="checkbox" class="gradeFilter" value="No Data" checked> No Data</label>
  </div>

  <div id="legend">
    <strong>Grade Legend</strong><br>
    <div><span class="legend-color" style="background:green;"></span> A</div>
    <div><span class="legend-color" style="background:lightgreen;"></span> B</div>
    <div><span class="legend-color" style="background:yellow;"></span> C</div>
    <div><span class="legend-color" style="background:orange;"></span> D</div>
    <div><span class="legend-color" style="background:red;"></span> F</div>
    <div><span class="legend-color" style="background:gray;"></span> No Data</div>
  </div>

  <div class="search-box">
    <input id="reachSearch" type="text" placeholder="Search Reach ID" style="width:160px; padding:4px;">
</div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([40.1, -105.87], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const parameterSelect = document.getElementById('parameterSelect');
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vROJntSYDQdg2vU1VTlMy8E-qOsSe9wr5_JMj1n1ks2wonNsk-JippjXmzizJJ9_BfgwMzzBV0Af50h/pub?gid=61075690&single=true&output=csv";
    const geojsonUrl = "https://calaneve.github.io/streammap/LBD_ReachCharacterization_GCSWGS84.geojson";

    let gradeData = {};
    let gradeColumns = [];
    let geojsonLayer;
    let highlightedLayer;

    function getColor(grade) {
      switch (grade) {
        case 'A': return 'green';
        case 'B': return 'lightgreen';
        case 'C': return 'yellow';
        case 'D': return 'orange';
        case 'F': return 'red';
        case 'No Data':
        case '': return 'gray';
        default: return 'gray';
      }
    }

    async function fetchCSV() {
      const response = await fetch(csvUrl);
      const text = await response.text();
      const rows = text.trim().split('\n').map(row => row.split(','));
      const headers = rows[0].map(h => h.trim());

      gradeColumns = headers.slice(2);

      const data = rows.slice(1).map(row => {
        const obj = {};
        headers.forEach((key, i) => obj[key] = row[i]?.trim());
        return obj;
      });

      gradeData = {};
      data.forEach(row => {
        gradeData[row.reach_id] = row;
      });

      parameterSelect.innerHTML = gradeColumns.map(col =>
        `<option value="${col}">${col}</option>`
      ).join('');
    }

    async function loadGeoJSON() {
      const response = await fetch(geojsonUrl);
      return await response.json();
    }

    function getActiveGradeFilters() {
      return Array.from(document.querySelectorAll('.gradeFilter:checked')).map(cb => cb.value);
    }

    async function updateMap() {
      if (geojsonLayer) map.removeLayer(geojsonLayer);

      const selectedParam = parameterSelect.value;
      const activeGrades = getActiveGradeFilters();
      const geojson = await loadGeoJSON();

      geojsonLayer = L.geoJSON(geojson, {
        filter: feature => {
          const row = gradeData[feature.properties.reach_id];
          if (!row) return false;
          const grade = row[selectedParam]?.trim() || 'No Data';
          return activeGrades.includes(grade);
        },
        style: feature => {
          const row = gradeData[feature.properties.reach_id];
          const grade = row?.[selectedParam]?.trim() || 'No Data';
          return {
            color: getColor(grade),
            weight: 6
          };
        },
        onEachFeature: (feature, layer) => {
          layer.on("mouseover", function () {
            const id = feature.properties.reach_id;
            const record = gradeData[id];
            if (!record) return;

            let popupContent = `<strong>Reach ID: ${id}</strong><br><table style=\"border-collapse: collapse;\">`;
            for (const key in record) {
              if (key !== "reach" && key !== "color" && key !== "grade") {
                const val = record[key]?.trim() || 'No Data';
                const isSelected = key === parameterSelect.value;
                const keyStyled = isSelected ? `<strong style=\"color:blue;\">${key}</strong>` : key;
                const valStyled = isSelected ? `<strong style=\"color:blue;\">${val}</strong>` : val;
                popupContent += `<tr><td style=\"padding: 2px 6px;\">${keyStyled}</td><td style=\"padding: 2px 6px;\">=</td><td style=\"padding: 2px 6px;\">${valStyled}</td></tr>`;
              }
            }
            popupContent += `</table>`;
            layer.bindTooltip(popupContent, { sticky: true }).openTooltip();
          });
          layer.on("mouseout", function () {
            layer.closeTooltip();
          });
        }
      }).addTo(map);
    }

    document.getElementById('reachSearch').addEventListener('input', function () {
      const query = this.value.trim();

      if (highlightedLayer) {
        map.removeLayer(highlightedLayer);
        highlightedLayer = null;
      }

      if (!query) return;

      const selectedFeature = geojsonLayer.getLayers().find(layer => {
        return layer.feature.properties.reach_id === query;
      });

      if (selectedFeature) {
        highlightedLayer = L.geoJSON(selectedFeature.feature, {
          style: {
            color: 'blue',
            weight: 6
          }
        }).addTo(map);

        selectedFeature.openPopup();
        map.fitBounds(highlightedLayer.getBounds());
      }
    });

    async function initialize() {
      await fetchCSV();
      await updateMap();
    }

    fetch("https://calaneve.github.io/streammap/LBD_CEA_Boundary.geojson")
      .then(res => res.json())
      .then(data => {
        const ceaLayer = L.geoJSON(data, {
          style: { color: "purple", weight: 2, fillOpacity: 0, fill: false }
        }).addTo(map);
        map.fitBounds(ceaLayer.getBounds());
      });

    parameterSelect.addEventListener('change', updateMap);
    document.querySelectorAll('.gradeFilter').forEach(cb =>
      cb.addEventListener('change', updateMap)
    );

    initialize();
  </script>
</body>
</html>

